# mem
xv6仅使用16位实模式和32位保护模式. xv6在引导的初始阶段运行在实模式下, 然后从实模式切换到保护模式.

32位保护模式的内存管理分为分段管理和分页管理. 该模式下, MMU的分段管理部件SU把逻辑地址转为线性地址, 分页管理部件PU把线性地址转为物理地址.

x86的32位保护模式的逻辑地址由段寄存器CS,DS, ES,FS,GS和SS中存放的16位段选择符和32位段内偏移量构成, 即逻辑地址=16位段选择符:32位段内偏移量.

32位的段基址包含在每个段8字节的描述符(Descriptor)中, kernel将相关的描述符以array的形式存储, 称为描述符表(Descriptor Table, DT). 段描述符的高13位=段在描述符表中的索引号. 分段单元用选择符在DT中查到描述符从而得到段基址, 然后与段内偏移相加得到32位的线性地址, 即va=32位基地址 + 32位段内偏移.

DT中与段选择符s相对应的描述符sd以及s的索引号i之间的关系:
1. i=s>>3
2. sd = DT[i]=DT[s>>3]

仅分段未分页时: va = pa, 转换由分段管理部件自动完成
分页: va->页表->pa, 转换由MMU的分页部件自动完成

x86的分页为虚拟内存管理提供支持, 分页机制将进程页面和物理帧的对应关系记录在页表中. 4KB分页方式通过页目录(Page Directory, PD)和页表(Page Table, PT)两级索引. 32位va被分成页目录索引d, 页表索引t和页内偏移o三部分, 假设va所在物理帧的起始地址pb, 那么转换过程是:
1. 通过d在PD中查到PT对应的pde, 进而得到PT的物理地址: pde=PD[d]
1. 通过t在页PT中查到页对应的pte, 进而得到pb: pte=PT[t]
1. pa = pb+o
