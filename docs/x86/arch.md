# x86

intel的段机制是从8086开始的, 目的是为了解决cpu 16位地址到20位实地址的转换. 为了向下兼容, x84仍使用了段机制, 但比8082更复杂. xv6和linux类似, 均未完全采用intel提供的段机制, 仅仅非常有限地使用了分段机制.

## 保护模式和段寄存器
32位保护模式下逻辑地址和线性地址的转换按照分段机制完成. 该过程较为复杂, 涉及描述符, 描述符表, 选择符和任务状态段这4种数据结构以及段寄存器, 任务寄存器和系统地址寄存器, 控制寄存器和标志寄存器.

分段机制看起来很复杂, 其核心是描述符表.

### 描述符和描述符表
一个描述符共64位, 由12位段属性, 32位段基址和20位段界限构成.

描述符表用于存储描述符, 是描述符构成的数组.

3个描述符表:
1. 全局描述符表GDT

    GDT中的第一个条目，索引为0。根据x86规范，索引为0的条目必须是空描述符（Null Descriptor）。它通常被全零填充，用于捕获对空段选择子的非法使用
1. 中断描述符表IDT, 每个表项称为一个门描述符
1. 局部描述符表LDT, 每个任务可以有一张. 该表被当作一个段来管理. xv6未使用LDT

为访问描述符表中的描述符, 需要描述符表的地址和索引. GDT, LDT和IDT的地址分别由GDTR, LDTR和IDTR来存储. IDT由8位的中断向量号来索引, GDT和LDT由16位的段选择符的高13位来索引, GDT和LDT由段选择符的TI位来区分. 段选择符用段寄存器或LDTR或任务寄存器TR的16位可见部分来存储. TR保存TSS的段选择符.

系统段描述符包括LDT的描述符和TSS描述符.
门描述符包括调用门/中断门/陷阱门/任务门描述符. 门用于任务转换, 实现从一个任务进入另一个任务; 门描述符则描述了门的属性(如特权级, 段内偏移量等)

xv6未使用调用门描述符. 调用门用于在不同特权级间实现受控的程序控制转移, 通常仅用于使用特权级保护机制的os中. 调用门描述符可以放在GDT和LGT中, 但不能放在IDT中.

### 系统地址寄存器
系统地址寄存器存放描述符表地址, 包括:
- 全局描述表寄存器GDTR（Global Descriptor Table Register ）

    gdtr是一个48位的寄存器，高32位用来存放段描述符地址，低16位用来存放段描述符的界限.
- 局部描述表寄存器LDTR（Local Descriptor Table Register ）, **现代处理器未使用ldtr**.

    LDTR=16位段选择符(可见) + 64位描述符(不可见)
- 中断描述表寄存器IDTR

    IDTR = 一个48位的寄存器, 32 位基地址和 16 位表长度值

    指令 LIDT 和 SIDT 分别用于加载和保存 IDTR 寄存器的内容. 在机器刚加电或处理器复位后，基地址被默认地设置为 0，而长度值被设置成 0xFFFF.

### 段选择符和任务寄存器
16位段选择符 = 13位描述符表索引(最多8192个描述符) + 1位TI(table indicator) + 2位RPL构成, 用于索引描述符表GDT和LDT, 可用6个段寄存器CS, DS, ES, FS, GS和SS之一存放.

RPL(Requested Privilege Level): 表示以什么样的权限去访问段, 用于特权检查.

RPL用法如下: 每当程序试图访问一个段时, MMU把当前特权级与所访问段的特权级进行比较, 以确定是否允许程序访问该段. 使用段选择符的RPL将改变特权级的检查规则, 在这种情况下, 与所访问段的特权级比较的特权级不是CPL, 而是CPL和RPL中更外层的特权级, 这样高特权级的代码可以用低特权级来访问其他段. 有些情况下高特权级的代码需熬访问低特权级的空间, 但是不需要以高特权级的身份访问, 以保护被访问空间的安全性. RPL为这种情况提供了可能, 比如当前CPL=0的内核代码要访问一个用户数据段, 如果把段选择符中的RPL设为3, 这样它对该段仍然只有特权为3的访问权限.

调用者设定的RPL是不可靠的, 为了防止调用者以调用函数的高特权级来访问其余数据段, 内核的函数得到调用者的RPL后, 需要检查其RPL并用相关指令进行调整.

TSS是一种特殊的用于记录任务的寄存器等信息的段.

任务寄存器TR用于存放GDT中的一个16位TSS选择符, 该TSS被称为当前TSS.

6个段寄存器CS, DS, ES, FS, GS和SS中, 每个都包括16位可见部分和64位不可见部分(描述符高速缓存器, Descriptor, cache register), 可见部分存放段选择符, 不可见部分缓存描述符. 其中CS指向GDT或LDT的代码描述符, DS, ES, FS, GS和SS指向GDT或LDT的数据描述符.

任务状态段是由26个32位整数构成的一个表, 主要保存CPU的寄存器. 该表被当作一个段来管理, 由系统描述符中的TSS描述符来描述.

### 逻辑地址到线性地址
逻辑地址到线性地址由cpu mmu的分段单元自动完成, 过程如下:
1. 段选择符的TI位是0或1, 表示了当前要转换的是GDT(TI=0)还是LDT(TI=1)中的段, 再根据GDTR和LDTR得到GDT或LDT表的基地址
1. 通过段选择符中的索引(15~3位)在表中查到对应的描述符, 得到段的基地址
1. 计算线性地址

### xv6
```c
// --- GDT, proc.h
struct segdesc gdt[NSEGS];   // x86 global descriptor table
// --- IDT, trap.c
struct gatedesc idt[256];
```